var CRITICAL_ERRORS,INVALID_OR_EXPIRED_TOKEN,MAX_COUNT,Promise,RATE_LIMIT_EXCEEDED,TwitterClient,TwitterCrawler,_,enabled,errorCode,extend,isArray,isInt,logger,slice=[].slice,indexOf=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};TwitterClient=require("twitter"),Promise=require("bluebird"),_=require("underscore"),isArray=_.isArray,extend=_.extendOwn,logger=require("winston"),MAX_COUNT=200,RATE_LIMIT_EXCEEDED=88,INVALID_OR_EXPIRED_TOKEN=89,CRITICAL_ERRORS=[RATE_LIMIT_EXCEEDED,INVALID_OR_EXPIRED_TOKEN],isInt=function(e){return!isNaN(e)&&parseInt(Number(e))===e&&!isNaN(parseInt(e,10))},errorCode=function(e){return e.code||(e[0]?e[0].code:0)},enabled=function(e){return e.filter(function(e){return function(e){return null==e.enabled||e.enabled}}(this))},TwitterCrawler=function(){function e(e,t){null==t&&(t={}),this.setOptions(t),this.count=0,this.createClients(e)}return e.prototype.validateCredentials=function(e){if(!e||isArray(e)&&0===enabled(e).length)throw new Error("You must provide valid credentials")},e.prototype.createClients=function(e){return this.clients=[],this.validateCredentials(e),enabled(e).forEach(function(e){return function(t){var r;return r=new TwitterClient(t),r._instance_id=e.clients.length,r._valid=!0,e.clients.push(r)}}(this))},e.prototype.setOptions=function(e){return this.options=extend({debug:!1},e)},e.prototype.getInstance=function(){var e,t;for(t=this.count%this.clients.length,e=1,this.count++;!this.clients[t]._valid&&e<=this.clients.length;)e+=1,this.count++,t=this.count%this.clients.length;return e>this.clients.length?null:(logger.debug("Using twitter credentials nÂº"+t),this.clients[t])},e.prototype.callApi=function(){var e,t;if(t=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],"get"!==t&&"post"!==t)throw new Error("Method '"+t+"' not implemented.");return new Promise(function(r){return function(n,i){var o,l,s;return l=r.getInstance(),null!=l?(o=function(o,s){var c,a;return o?(c="Error calling '"+e[0]+"' api ["+t.toUpperCase()+"] on instance "+l._instance_id+".",32===errorCode(o)&&(c+=" Error code: "+errorCode(o)+".",logger.error(c,"Using another instance.",o),r.callApi.apply(r,[t].concat(slice.call(e))).then(n)["catch"](i)),a=errorCode(o),indexOf.call(CRITICAL_ERRORS,a)>=0?(c+=" Error code: "+errorCode(o)+".",l._valid=!1,l._error=o,logger.error(c,"Using another instance.",o),r.callApi.apply(r,[t].concat(slice.call(e))).then(n)["catch"](i)):(logger.error(c),logger.error(o),i(o))):n(s)},l[t].apply(l,e.concat([o]))):(s="All instances are invalid! Review your credentials",logger.debug(s),i(new Error(s)))}}(this))},e.prototype.get=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["get"].concat(slice.call(e)))},e.prototype.post=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["post"].concat(slice.call(e)))},e.prototype._getTweets=function(e,t,r){return null==r&&(r=[]),new Promise(function(n){return function(i,o){var l;return l=function(l){var s,c;return logger.debug("Obtained",l.length,"for userId",e.user_id+".","Total tweets for user:",l.length+r.length),s=t.limit&&r.length+l.length>t.limit,l.length>1&&!s?n._getTweets(extend(e,{maxId:l[l.length-1].id-1}),t,r.concat(l)).done(i,o):(c=r.concat(l),t.limit&&(c=c.slice(0,+t.limit+1||9e9)),i(c))},n.get("statuses/user_timeline",e).done(l,o)}}(this))},e.prototype.getTweets=function(e,t){var r;return null==t&&(t={}),r={user_id:isInt(e)?e:void 0,screen_name:isInt(e)?void 0:e.replace("@",""),count:MAX_COUNT,exclude_replies:!0,trim_user:!0,maxId:void 0},this._getTweets(r,t)},e.prototype.getUser=function(e){var t;return t={user_id:isInt(e)?e:void 0,screen_name:isInt(e)?void 0:e.replace("@","")},this.get("users/show",t)},e}(),module.exports=TwitterCrawler;