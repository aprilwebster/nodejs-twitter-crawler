var CRITICAL_ERRORS,INVALID_OR_EXPIRED_TOKEN,MAX_COUNT,Promise,RATE_LIMIT_EXCEEDED,TwitterClient,TwitterCrawler,_,enabled,errorCode,extend,getLogger,isArray,isInt,isString,winston,slice=[].slice,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};TwitterClient=require("twitter"),Promise=require("bluebird"),_=require("underscore"),isString=_.isString,isArray=_.isArray,extend=_.extendOwn,winston=require("winston"),MAX_COUNT=200,RATE_LIMIT_EXCEEDED=88,INVALID_OR_EXPIRED_TOKEN=89,CRITICAL_ERRORS=[RATE_LIMIT_EXCEEDED,INVALID_OR_EXPIRED_TOKEN],getLogger=function(e){return null==e&&(e={}),new winston.Logger({transports:[new winston.transports.Console({level:e.debug?"debug":"info",label:"twitter-crawler"})]})},isInt=function(e){return!isNaN(e)&&parseInt(Number(e))===e&&!isNaN(parseInt(e,10))},errorCode=function(e){return e.code||(e[0]?e[0].code:0)},enabled=function(e){return e.filter(function(e){return function(e){return null==e.enabled||e.enabled}}(this))},TwitterCrawler=function(){function e(e,t){null==t&&(t={}),this.logger=getLogger(t),this.setOptions(t),this.count=0,this.createClients(e)}return e.prototype.validateCredentials=function(e){if(!e||isArray(e)&&0===enabled(e).length)throw new Error("You must provide valid credentials")},e.prototype.createClients=function(e){return this.clients=[],this.validateCredentials(e),enabled(e).forEach(function(e){return function(t){var n;return n=new TwitterClient(t),n._instance_id=e.clients.length,n._valid=!0,e.clients.push(n)}}(this))},e.prototype.setOptions=function(e){return this.options=extend({debug:!1},e)},e.prototype.getInstance=function(){var e,t;for(t=this.count%this.clients.length,e=1,this.count++;!this.clients[t]._valid&&e<=this.clients.length;)e+=1,this.count++,t=this.count%this.clients.length;return e>this.clients.length?null:(this.logger.debug("Using twitter credentials nÂº"+t),this.clients[t])},e.prototype.callApi=function(){var e,t;if(t=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],"get"!==t&&"post"!==t)throw new Error("Method '"+t+"' not implemented.");return new Promise(function(n){return function(r,i){var o,s,l;return s=n.getInstance(),null!=s?(o=function(o,l){var c,a;return o?(c="Error calling '"+e[0]+"' api ["+t.toUpperCase()+"] on instance "+s._instance_id+".",32===errorCode(o)&&(c+=" Error code: "+errorCode(o)+".",n.logger.error(c,"Using another instance.",o),n.callApi.apply(n,[t].concat(slice.call(e))).then(r)["catch"](i)),a=errorCode(o),indexOf.call(CRITICAL_ERRORS,a)>=0?(c+=" Error code: "+errorCode(o)+".",s._valid=!1,s._error=o,n.logger.error(c,"Using another instance.",o),n.callApi.apply(n,[t].concat(slice.call(e))).then(r)["catch"](i)):(n.logger.error(c),n.logger.error(o),i(o))):r(l)},s[t].apply(s,e.concat([o]))):(l="All instances are invalid! Review your credentials",n.logger.debug(l),i(new Error(l)))}}(this))},e.prototype.get=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["get"].concat(slice.call(e)))},e.prototype.post=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["post"].concat(slice.call(e)))},e.prototype._getTweets=function(e,t,n){return null==n&&(n=[]),new Promise(function(r){return function(i,o){var s;return s=function(s){var l,c;return r.logger.debug("Obtained",s.length,"for userId",e.user_id+".","Total tweets for user:",s.length+n.length),l=t.limit&&n.length+s.length>t.limit,s.length>1&&!l?r._getTweets(extend(e,{maxId:s[s.length-1].id-1}),t,n.concat(s)).done(i,o):(c=n.concat(s),t.limit&&(c=c.slice(0,+t.limit+1||9e9)),i(c))},r.get("statuses/user_timeline",e).done(s,o)}}(this))},e.prototype.getTweets=function(e,t){var n;return null==t&&(t={}),(isString(e)||isInt(e))&&(n=e,e={user_id:isInt(n)?n:void 0,screen_name:isInt(n)?void 0:n.replace("@",""),count:MAX_COUNT,exclude_replies:!0,trim_user:!0,maxId:void 0,include_rts:!1}),this._getTweets(e,t)},e.prototype.getUser=function(e){var t;return(isString(e)||isInt(e))&&(t=e,e={user_id:isInt(t)?t:void 0,screen_name:isInt(t)?void 0:t.replace("@","")}),this.get("users/show",e)},e}(),module.exports=TwitterCrawler;